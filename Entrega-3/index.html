<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Pizza Index</title>
        <link rel="icon" href="assets/icons/pizza.svg" type="image/svg+xml">
        <link rel="stylesheet" href="style.css">

<body>
        <header class="header">
            <h1>
                <img src="assets/icons/pizza.svg" alt="Pizza" class="title-icon">
                Pizza Index
            </h1>
            <p>Detector de pizzas en tiempo real</p>
        </header>

        <div class="top-right-controls">
            <button id="local-camera-btn" class="btn-secondary">üé• Testear con C√°mara Local</button>
            <button id="stop-camera-btn" class="btn-secondary" style="display: none;">‚èπÔ∏è Detener C√°mara</button>
        </div>

        <div class="main-content">
            <!-- Columna Izquierda: Estad√≠sticas y Eventos -->
            <div class="left-column">
                <!-- EVENTO DETECTADO -->
                <div id="event-display" class="event-display" style="display: none;">
                    <div class="event-header">
                        <h2 id="event-title">Evento Detectado</h2>
                    </div>
                    <div class="event-content">
                        <div class="event-main">
                            <div class="event-emoji" id="event-emoji">üçï</div>
                            <div class="event-details">
                                <h3 id="event-name">Nombre del Evento</h3>
                                <p id="event-date" class="event-date">Fecha</p>
                                <p id="event-category" class="event-category">Categor√≠a</p>
                            </div>
                        </div>
                        <div class="event-stats">
                            <div class="stat-box">
                                <div class="stat-label">Pizzas Cr√≠ticas</div>
                                <div class="stat-number" id="event-pizzas-criticas">0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Incremento</div>
                                <div class="stat-number" id="event-incremento">0%</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Gravedad</div>
                                <div class="stat-number" id="event-gravedad">-</div>
                            </div>
                        </div>
                        <div class="event-description">
                            <p id="event-desc">Descripci√≥n del evento</p>
                        </div>
                    </div>
                </div>

                <div id="info">
                    <div id="detection">Ninguna pizza detectada</div>
                </div>

                <div class="stats-container">
                    <h3>ü§ñ Predicciones del Modelo</h3>
                    <div id="ml-predictions" class="ml-predictions">
                        <p class="loading-ml">Cargando modelo...</p>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: C√°mara y Controles -->
            <div class="right-column">
                <div class="main-controls">
                    <div class="button-group">
                    </div>
                </div>

                <div id="video-container">
                    <video id="video" autoplay playsinline style="display: none;"></video>
                    <canvas id="canvas"></canvas>
                    <canvas id="detection-canvas"></canvas>
                    <div id="placeholder">
                        <p>Haga clic en "Usar C√°mara Local" para iniciar</p>
                    </div>
                </div>

                <div class="volume-control" style="margin-top: -45px;">
                    <div id="volumeIconWrapper" class="volume-icon-wrapper">
                        <svg class="volume-icon-unmuted" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                        </svg>
                        <svg class="volume-icon-muted" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <line x1="23" y1="9" x2="17" y2="15"></line>
                            <line x1="17" y1="9" x2="23" y2="15"></line>
                        </svg>
                    </div>
                    <input type="range" id="volumeSlider" min="0" max="100" value="50" class="volume-slider">
                </div>
            </div>
        </div>
        <footer class="footer">
            <p>Proyecto IIC2026 - Visualizaci√≥n de Informaci√≥n 2025</p>
        </footer>
    </body>

    <!-- Scripts movidos al final para asegurar que el DOM est√© cargado -->
    <!-- TensorFlow.js y Teachable Machine -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.4/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
    
    <!-- Motor de Audio -->
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <!-- Datos de eventos -->
    <script src="events.js"></script>
    <script src="audio.js"></script>

    <!-- Scripts de Protobject Framework -->
    <script src="https://app.protobject.com/framework/p.js"></script>
    <script src="config.js"></script>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const detectionCanvas = document.getElementById('detection-canvas');
        const detectionCtx = detectionCanvas.getContext('2d');
        const video = document.getElementById('video');
        const detectionEl = document.getElementById('detection');
        const debugLog = document.getElementById('debug-log'); // Restaurado para evitar ReferenceError
        const placeholder = document.getElementById('placeholder');
        const localCameraBtn = document.getElementById('local-camera-btn');
        const stopCameraBtn = document.getElementById('stop-camera-btn');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeIconWrapper = document.getElementById('volumeIconWrapper');
        const mlPredictionsEl = document.getElementById('ml-predictions');
        
        let frameCount = 0;
        let isConnected = false;
        let localStream = null;
        let animationId = null;
        
        // Variables para el modelo ML
        let model = null;
        let modelLoaded = false;
        const MODEL_URL = './model.json';
        const METADATA_URL = './metadata.json';
        
        // Variables para detecci√≥n de eventos
        let eventoActual = null;
        let lastDetectionTime = 0; // Para el buffer de detecci√≥n
        
        // =======================================================================
        // ASIGNACI√ìN DE CLASES DEL MODELO A EVENTOS
        // =======================================================================
        const MODEL_CLASS_MAPPING = {
            "Class 1": { color: "ROJO", tama√±o: 15 },   // Mapeado a Invasi√≥n de Irak
            "Class 2": { color: "AZUL", tama√±o: 15 },   // Mapeado a 11 de Septiembre
        };
        
                            // ========================================== 
                            // FUNCIONES DE DEBUG
                            // ========================================== 
                            function log(message, type = 'info') {
                                console.log(message);
                                // El contenedor de debug fue eliminado, solo se loguea a la consola.
                            }
                    
                            // ========================================== 
                            // FUNCIONES DE EVENTOS
                            // ========================================== 
                            function mostrarEvento(evento) {
                                if (!evento) return;
                                const display = document.getElementById('event-display');
                                
                                // Actualizar contenido
                                document.getElementById('event-emoji').innerHTML = `<img src="${COLORES_CONFIG[evento.color].icono}" alt="${COLORES_CONFIG[evento.color].nombre}" style="width: 48px; height: 48px;">`;
                                document.getElementById('event-name').textContent = evento.nombre;
                                document.getElementById('event-date').textContent = evento.fecha;
                                document.getElementById('event-category').textContent = evento.categoria;
                                document.getElementById('event-pizzas-criticas').textContent = evento.pizzasCriticas;
                                document.getElementById('event-incremento').textContent = evento.incremento + '%';
                                document.getElementById('event-gravedad').textContent = TAMA√ëOS_CONFIG[evento.tama√±o].gravedad;
                                document.getElementById('event-desc').textContent = evento.descripcion;
                    
                                // Aplicar color de categor√≠a
                                const colorConfig = COLORES_CONFIG[evento.color];
                                display.style.borderLeftColor = colorConfig.hex;
                    
                                // Mostrar con animaci√≥n
                                display.style.display = 'block';
                                setTimeout(() => display.classList.add('show'), 10);
                            }
                    
                            function cerrarEvento() {
                                const display = document.getElementById('event-display');
                                display.classList.remove('show');
                                setTimeout(() => {
                                    display.style.display = 'none';
                                    eventoActual = null;
                                }, 300);
                            }
                    
                            // ========================================== 
                            // CARGAR MODELO DE TEACHABLE MACHINE
                            // ========================================== 
                            async function cargarModelo() {
                                try {
                                    log('Cargando modelo de ML...', 'info');
                                    model = await tmImage.load(MODEL_URL, METADATA_URL);
                                    modelLoaded = true;
                                    log('‚úÖ Modelo cargado exitosamente', 'success');
                                    mlPredictionsEl.innerHTML = '<p class="ml-ready">Modelo listo para detectar.</p>';
                                } catch (error) {
                                    log('‚ùå Error cargando el modelo: ' + error.message, 'error');
                                    mlPredictionsEl.innerHTML = '<p class="error-ml">Error al cargar el modelo.</p>';
                                }
                            }
                    
                            // ========================================== 
                            // HACER PREDICCI√ìN Y MANEJAR L√ìGICA DE EVENTOS
                            // ========================================== 
                            async function predecirConModelo() {
                                if (!modelLoaded || !model || !canvas.width) return;
                    
                                try {
                                    const predictions = await model.predict(canvas);
                                    predictions.sort((a, b) => b.probability - a.probability);
                    
                                    const predHTML = predictions.map((pred, idx) => {
                                        const percentage = (pred.probability * 100).toFixed(1);
                                        const barWidth = percentage;
                                        const isTop = idx === 0;
                                        return `
                                            <div class="prediction-item ${isTop ? 'top-prediction' : ''}">
                                                <div class="prediction-label">${pred.className}</div>
                                                <div class="prediction-bar-container">
                                                    <div class="prediction-bar" style="width: ${barWidth}%"></div>
                                                </div>
                                                <div class="prediction-value">${percentage}%</div>
                                            </div>
                                        `;
                                    }).join('');
                                    mlPredictionsEl.innerHTML = predHTML;
                    
                                    const topPrediction = predictions[0];
                                    const confidenceThreshold = 0.50;
                    
                                    if (topPrediction && topPrediction.probability > confidenceThreshold) {
                                        const detectedClassName = topPrediction.className;
                                        const eventConfig = MODEL_CLASS_MAPPING[detectedClassName];
                    
                                        if (eventConfig) {
                                            const eventoDetectado = buscarEvento(eventConfig.color, eventConfig.tama√±o);
                                            if (eventoDetectado) {
                                                detectionEl.textContent = `üéØ Evento: ${eventoDetectado.nombre} (${(topPrediction.probability * 100).toFixed(1)}%)`;
                                                if (!eventoActual || eventoActual.id !== eventoDetectado.id) {
                                                    const now = Date.now();
                                                    if (now - lastDetectionTime < 3000) return;
                                                    lastDetectionTime = now;
                                                    
                                                    AudioEngine.stopAll();
                                                    AudioEngine.play(eventoDetectado);
                                                    eventoActual = eventoDetectado;
                                                    mostrarEvento(eventoDetectado);
                                                }
                                            }
                                        } else {
                                            if (eventoActual) {
                                                detectionEl.textContent = '‚è≥ Esperando detecci√≥n...';
                                                cerrarEvento();
                                                AudioEngine.stopAll();
                                            }
                                        }
                                    } else {
                                        if (eventoActual) {
                                            detectionEl.textContent = '‚è≥ Esperando detecci√≥n...';
                                            lastDetectionTime = 0;
                                            cerrarEvento();
                                            AudioEngine.stopAll();
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error en predicci√≥n:', error);
                                    if (eventoActual) {
                                        cerrarEvento();
                                        AudioEngine.stopAll();
                                    }
                                }
                            }
        
        // ========================================== 
        // CONTROLES DE AUDIO
        // ========================================== 
        volumeSlider.addEventListener('input', (e) => {
            const volume = parseInt(e.target.value);
            AudioEngine.setVolume(volume);
            volumeIconWrapper.parentElement.classList.toggle('is-muted', volume === 0);
        });

        volumeIconWrapper.addEventListener('click', () => {
            const { isMuted, volume } = AudioEngine.toggleMute();
            volumeSlider.value = isMuted ? 0 : volume;
            volumeIconWrapper.parentElement.classList.toggle('is-muted', isMuted);
        });

        // ========================================== 
        // C√ÅMARA LOCAL
        // ========================================== 
        localCameraBtn.addEventListener('click', async () => {
            try {
                await AudioEngine.start();
                log('üé• Iniciando c√°mara local...', 'info');
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 640 }, height: { ideal: 480 } }
                });
                video.srcObject = localStream;
                video.style.display = 'none';
                placeholder.style.display = 'none';
                isConnected = true;
                localCameraBtn.style.display = 'none';
                stopCameraBtn.style.display = 'inline-block';
                log('‚úÖ C√°mara local iniciada correctamente', 'success');

                processLocalCamera();
            } catch (error) {
                log('‚ùå Error accediendo a c√°mara: ' + error.message, 'error');
                alert('No se pudo iniciar la c√°mara: ' + error.message);
            }
        });

        stopCameraBtn.addEventListener('click', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                video.srcObject = null;
                isConnected = false;
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                placeholder.style.display = 'flex';
                localCameraBtn.style.display = 'inline-block';
                stopCameraBtn.style.display = 'none';
                log('‚èπÔ∏è C√°mara local detenida', 'info');
            }
        });

        function processLocalCamera() {
            if (!isConnected || !video.videoWidth) {
                animationId = requestAnimationFrame(processLocalCamera);
                return;
            }
            if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                detectionCanvas.width = video.videoWidth;
                detectionCanvas.height = video.videoHeight;
            }
            ctx.drawImage(video, 0, 0);
            frameCount++;
            predecirConModelo();
            animationId = requestAnimationFrame(processLocalCamera);
        }

        // ==========================================
        // RECIBIR MENSAJES DEL CELULAR
        // ==========================================
        Protobject.Core.onReceived(function (message) {
            if (!isConnected) {
                isConnected = true;
                placeholder.style.display = 'none';
                log('üì± Celular conectado exitosamente', 'success');
            }

            if (message && message.type === 'frame') {
                const img = new Image();
                img.onload = () => {
                    if (canvas.width !== img.width || canvas.height !== img.height) {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        detectionCanvas.width = img.width;
                        detectionCanvas.height = img.height;
                    }
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    frameCount++;
                    predecirConModelo();
                };
                img.onerror = () => {
                    log('‚ùå Error cargando frame', 'error');
                };
                img.src = message.frame;
            }
        });

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        console.log('%cüîß SISTEMA DE REUBICACI√ìN PROTOBJECT ACTIVO', 'background: #0891b2; color: white; padding: 5px; font-weight: bold;');
        console.log('üìç Todos los elementos de Protobject ser√°n movidos a .button-group');
        console.log('üîç Abre la consola para ver el proceso en tiempo real');

        log('üçï Pizza Index iniciado (Computador)', 'success');
        cargarModelo();

        function startAudioOnFirstClick() {
            AudioEngine.start();
            document.removeEventListener('click', startAudioOnFirstClick);
        }
        document.addEventListener('click', startAudioOnFirstClick);

        // ==========================================
        // MOVER TODOS LOS ELEMENTOS DE PROTOBJECT AL CONTENEDOR
        // ==========================================
        let elementosMovidos = new Set(); // Para trackear qu√© elementos ya movimos

        function moverElementosProtobject() {
            const buttonGroup = document.querySelector('.button-group');
            if (!buttonGroup) {
                console.log('‚ö†Ô∏è No se encontr√≥ .button-group');
                return;
            }

            const mainControls = document.querySelector('.main-controls');
            let elementosEncontrados = [];

            // 1. Buscar elementos con ID o clase que contenga "Protobject"
            const elementosConProtobject = document.querySelectorAll('[id^="Protobject"], [class*="protobject"], [id*="Protobject"], [class*="Protobject"]');
            elementosEncontrados.push(...elementosConProtobject);

            // 2. Buscar TODOS los div/canvas/img hijos directos del body con position absolute
            Array.from(document.body.children).forEach(el => {
                // Excluir elementos conocidos que NO son de Protobject
                if (el.classList.contains('header') ||
                    el.classList.contains('footer') ||
                    el.classList.contains('main-content') ||
                    el.classList.contains('top-right-controls') ||
                    el.classList.contains('button-group') ||
                    el.classList.contains('main-controls') ||
                    el.classList.contains('right-column') ||
                    el.classList.contains('left-column') ||
                    el === buttonGroup ||
                    el === mainControls ||
                    buttonGroup.contains(el) || // Ya est√° dentro del button-group
                    el.contains(buttonGroup) || // Es padre del button-group
                    el.tagName === 'SCRIPT' ||
                    el.tagName === 'STYLE' ||
                    el.tagName === 'VIDEO') {
                    return;
                }

                const style = window.getComputedStyle(el);
                const esAbsoluto = style.position === 'absolute' || style.position === 'fixed';

                if (esAbsoluto) {
                    elementosEncontrados.push(el);
                    console.log('üîç Elemento absoluto encontrado:', el.tagName, el.id || '(sin id)', el.textContent?.substring(0, 30) || '');
                }
            });

            // 2.5 Buscar espec√≠ficamente CANVAS que no sean los del video
            document.querySelectorAll('canvas').forEach(canvas => {
                if (canvas.id !== 'canvas' && canvas.id !== 'detection-canvas' && !buttonGroup.contains(canvas)) {
                    elementosEncontrados.push(canvas);
                    console.log('üîç Canvas encontrado (probablemente QR):', canvas.id || '(sin id)', canvas.width, 'x', canvas.height);
                }
            });

            // 3. Buscar espec√≠ficamente divs con texto que contengan palabras clave de Protobject
            document.querySelectorAll('body > div').forEach(div => {
                // Excluir contenedores principales
                if (div === buttonGroup ||
                    div === mainControls ||
                    div.contains(buttonGroup) ||
                    buttonGroup.contains(div) ||
                    div.classList.contains('header') ||
                    div.classList.contains('footer') ||
                    div.classList.contains('main-content') ||
                    div.classList.contains('top-right-controls')) {
                    return;
                }

                const texto = div.textContent || '';
                if (texto.includes('Celular') || texto.includes('Detector') || texto.includes('Conectado')) {
                    elementosEncontrados.push(div);
                    console.log('üîç Elemento con texto Protobject encontrado:', texto.substring(0, 50));
                }
            });

            // Eliminar duplicados
            const todosLosElementos = [...new Set(elementosEncontrados)];

            if (todosLosElementos.length > 0) {
                todosLosElementos.forEach(elemento => {
                    // VALIDACIONES DE SEGURIDAD
                    // Si ya lo movimos antes, no hacer nada
                    if (elementosMovidos.has(elemento)) return;

                    // NO mover si es el buttonGroup mismo o lo contiene
                    if (elemento === buttonGroup || elemento.contains(buttonGroup)) {
                        console.log('‚ö†Ô∏è Saltando elemento que contiene buttonGroup');
                        return;
                    }

                    // NO mover si ya est√° dentro del buttonGroup
                    if (buttonGroup.contains(elemento)) {
                        console.log('‚ö†Ô∏è Elemento ya est√° dentro del buttonGroup');
                        return;
                    }

                    // Remover estilos inline de posicionamiento
                    elemento.style.position = 'static';
                    elemento.style.top = '';
                    elemento.style.right = '';
                    elemento.style.bottom = '';
                    elemento.style.left = '';
                    elemento.style.transform = '';
                    elemento.style.margin = '0.5rem auto';
                    elemento.style.display = 'block';
                    elemento.style.textAlign = 'center';

                    // Ajustar tama√±o seg√∫n tipo de elemento
                    if (elemento.tagName === 'CANVAS') {
                        // Para QR codes, mantener tama√±o original pero limitado
                        elemento.style.maxWidth = '200px';
                        elemento.style.height = 'auto';
                    } else {
                        // Para texto, usar ancho completo del contenedor
                        elemento.style.width = 'auto';
                        elemento.style.maxWidth = '100%';
                    }

                    // Mover el elemento al contenedor (doble verificaci√≥n)
                    try {
                        buttonGroup.appendChild(elemento);
                        elementosMovidos.add(elemento);

                        // FORZAR visibilidad inmediatamente despu√©s de mover
                        elemento.style.opacity = '1';
                        elemento.style.visibility = 'visible';
                        elemento.style.pointerEvents = 'auto';

                        console.log('‚úÖ MOVIDO elemento de Protobject:', elemento.tagName, elemento.id || elemento.textContent?.substring(0, 30));
                    } catch (error) {
                        console.error('‚ùå Error al mover elemento:', error, elemento);
                    }
                });

                console.log(`üì¶ Total elementos de Protobject en contenedor: ${elementosMovidos.size}`);
            }
        }

        // Usar MutationObserver con debouncing para evitar llamadas excesivas
        let observerTimeout;
        const observer = new MutationObserver((mutations) => {
            // Solo procesar si se agregaron nodos nuevos al body
            const seAgregaronNodosAlBody = mutations.some(mutation =>
                mutation.type === 'childList' &&
                mutation.addedNodes.length > 0 &&
                mutation.target === document.body
            );

            if (seAgregaronNodosAlBody) {
                // Debounce: esperar 100ms antes de procesar
                clearTimeout(observerTimeout);
                observerTimeout = setTimeout(() => {
                    moverElementosProtobject();
                }, 100);
            }
        });

        // Observar cambios solo en hijos directos del body
        observer.observe(document.body, {
            childList: true,
            subtree: false, // Solo hijos directos del body
        });

        // Ejecutar peri√≥dicamente con setInterval (cada 500ms durante los primeros 10 segundos)
        let contador = 0;
        const intervalId = setInterval(() => {
            moverElementosProtobject();
            contador++;
            if (contador > 20) { // Detener despu√©s de 10 segundos (20 * 500ms)
                clearInterval(intervalId);
                console.log('‚èπÔ∏è Detenci√≥n de b√∫squeda autom√°tica de elementos Protobject');
            }
        }, 500);

        // Tambi√©n timeouts iniciales
        setTimeout(moverElementosProtobject, 100);
        setTimeout(moverElementosProtobject, 500);
        setTimeout(moverElementosProtobject, 1000);
        setTimeout(moverElementosProtobject, 2000);
        setTimeout(moverElementosProtobject, 3000);
    </script>
<style>
    :root {
        --primary-color: #0891b2;
        --primary-hover: #0e7490;
        --background: #f9fafb;
        --foreground: #111827;
        --muted: #f3f4f6;
        --muted-foreground: #6b7280;
        --border: #e5e7eb;
        --radius-sm: 0.375rem;
        --radius-md: 0.5rem;
        --radius-lg: 0.75rem;
        --transition-normal: 0.3s ease;
    }

    html, body {
        height: 100vh;
        margin: 0;
        overflow: hidden;
        background-color: var(--background);
        font-family: 'Montserrat', sans-serif;
    }

    body {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .header {
        padding: 0.25rem 2rem;
        text-align: center;
        flex-shrink: 0;
        border-bottom: 1px solid var(--border);
    }

    .header h1 {
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 0;
        margin-bottom: 0;
    }
    .header p {
        font-size: 0.9rem;
        margin: 0;
        color: var(--muted-foreground);
    }
    .title-icon {
        width: 24px;
        height: 24px;
    }

    .top-right-controls {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 10;
    }

    .footer {
        padding: 0.25rem 2rem;
        text-align: center;
        font-size: 0.75rem;
        color: var(--muted-foreground);
        flex-shrink: 0;
        border-top: 1px solid var(--border);
    }

    .main-content {
        display: flex;
        flex-grow: 1;
        min-height: 0;
        gap: 1rem;
        padding: 1rem;
    }

    .left-column {
        flex: 3;
        overflow-y: auto;
        padding: 1.5rem;
    }

    .right-column {
        flex: 1; /* 0.5 ratio part -> 1 */
        display: flex;
        flex-direction: column;
        justify-content: center; /* Centrar contenido verticalmente */
        align-items: center; /* Centrar contenido horizontalmente */
        min-width: 0;
        gap: 1.5rem;
        background: transparent; /* SIN CONTENEDOR */
        border: none; /* SIN CONTENEDOR */
        padding: 1.5rem;
        position: relative; /* Para que .button-group se posicione relativo a esta columna */
    }

    #video-container {
        width: 100%;
        aspect-ratio: 1 / 1;
        position: relative;
        background: black;
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    #canvas, #detection-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    #detection-canvas {
        pointer-events: none;
    }

    .main-controls {
        margin: 0;
        padding: 0;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
        position: relative; /* Para que .button-group se posicione correctamente */
        height: 0; /* No ocupa espacio en el flujo */
    }
    
    #info {
        width: 100%;
        background: var(--muted);
        border-radius: var(--radius-lg);
        padding: 2rem;
        text-align: center;
    }
    #status {
        font-weight: 500;
        color: var(--muted-foreground);
        margin-bottom: 0.5rem;
    }
    #detection {
        font-weight: 600;
        font-size: 1.2rem;
        color: var(--primary-color);
        min-height: 1.5em; /* Prevenir saltos de layout */
    }

    .stats-container {
        margin-top: 2rem;
    }
    
    .stats-container h3 {
        margin-bottom: 1rem;
        color: var(--foreground);
        font-size: 1.1rem;
        text-align: center;
    }

    /* Scrollbar para la columna izquierda */
    .left-column::-webkit-scrollbar { width: 8px; }
    .left-column::-webkit-scrollbar-track { background: transparent; }
    .left-column::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

    /* Estilos de botones y otros elementos */
    /* FORZAR TODOS LOS ELEMENTOS DE PROTOBJECT A POSICI√ìN EST√ÅTICA */
    [id^="Protobject"], [class*="protobject"], [id*="Protobject"], [class*="Protobject"] {
        position: static !important;
        top: auto !important;
        right: auto !important;
        bottom: auto !important;
        left: auto !important;
        transform: none !important;
    }

    /* Forzar elementos absolute hijos directos del body (excepto top-right-controls) */
    body > div[style*="position: absolute"]:not(.header):not(.footer):not(.main-content):not(.top-right-controls),
    body > div[style*="position:absolute"]:not(.header):not(.footer):not(.main-content):not(.top-right-controls) {
        position: static !important;
        top: auto !important;
        right: auto !important;
        bottom: auto !important;
        left: auto !important;
    }

    /* Personalizar bot√≥n de conexi√≥n de Protobject */
    #ProtobjectPlusButton {
        /* Forzar posicionamiento est√°tico cuando est√© en el contenedor */
        position: static !important;
        width: auto !important;
        min-width: 120px !important;
        background-color: var(--primary-color) !important;
        color: white !important;
        border: none !important;
        padding: 0.75rem 2rem !important;
        font-size: 1rem !important;
        border-radius: var(--radius-md) !important;
        font-family: 'Montserrat', sans-serif !important;
        font-weight: 600 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 0.5rem !important;
        cursor: pointer !important;
        transition: all var(--transition-normal) !important;
        /* Remover coordenadas de posicionamiento */
        top: auto !important;
        right: auto !important;
        bottom: auto !important;
        left: auto !important;
    }

    #ProtobjectPlusButton:hover {
        background-color: var(--primary-hover) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(8, 145, 178, 0.2) !important;
    }

    #ProtobjectPlusButton:after {
        content: ' Conectar';
    }

    /* Estilos para elementos de texto/estado de Protobject */
    [id^="Protobject"]:not(#ProtobjectPlusButton) {
        background: var(--muted) !important;
        color: var(--foreground) !important;
        padding: 0.5rem 1rem !important;
        border-radius: var(--radius-md) !important;
        font-family: 'Montserrat', sans-serif !important;
        font-size: 0.85rem !important;
        margin: 0.5rem auto !important;
        text-align: center !important;
        display: block !important;
        width: auto !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
    }

    /* Estilos para elementos dentro del button-group */
    .button-group > div:not(#ProtobjectPlusButton),
    .button-group > canvas,
    .button-group > img {
        flex-shrink: 0; /* No permitir que se compriman */
        width: auto !important;
        max-width: 100% !important;
    }

    /* Estilos para QR code de Protobject */
    img[id^="Protobject"], canvas[id^="Protobject"] {
        margin: 0.5rem auto !important;
        display: block !important;
        max-width: 200px !important;
        height: auto !important;
    }

    /* Canvas dentro del button-group (QR) */
    .button-group > canvas {
        max-width: 200px !important;
        height: auto !important;
        background: white !important;
        padding: 0.5rem !important;
        border-radius: var(--radius-md) !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    }

    /* REGLA NUCLEAR: Forzar TODOS los elementos hijos del body (excepto estructura) */
    body > div:not(.header):not(.footer):not(.main-content):not(.top-right-controls),
    body > canvas:not(#canvas):not(#detection-canvas) {
        /* Si tienen position absolute, probablemente son de Protobject */
    }

    /* Ocultar elementos de Protobject que aparezcan fuera del contenedor hasta que JS los mueva */
    body > div[style*="position"][style*="absolute"]:not(.header):not(.footer):not(.main-content):not(.top-right-controls),
    body > canvas[style*="position"][style*="absolute"]:not(#canvas):not(#detection-canvas) {
        opacity: 0 !important;
        pointer-events: none !important;
        transition: opacity 0.3s ease !important;
        visibility: hidden !important;
    }

    /* Cuando est√©n dentro del button-group, mostrarlos INMEDIATAMENTE */
    .button-group > div,
    .button-group > canvas,
    .button-group > img,
    .button-group [id^="Protobject"],
    .button-group * {
        opacity: 1 !important;
        pointer-events: auto !important;
        visibility: visible !important;
        transition: none !important;
    }

    .volume-control { display: flex; align-items: center; gap: 0.5rem; width: 180px; }
    .volume-icon-wrapper { position: relative; width: 24px; height: 24px; cursor: pointer; color: var(--muted-foreground); }
    .volume-icon-wrapper svg { position: absolute; top: 0; left: 0; transition: opacity 0.2s ease; }
    .volume-icon-muted { opacity: 0; }
    .volume-control.is-muted .volume-icon-unmuted { opacity: 0; }
    .volume-control.is-muted .volume-icon-muted { opacity: 1; }
    .volume-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: var(--border); border-radius: 3px; outline: none; cursor: pointer; }
    .volume-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--primary-color);
 border-radius: 50%; cursor: grab; border: 3px solid white; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); transition: all 0.2s ease; }
    .volume-slider::-moz-range-thumb { width: 20px; height: 20px; background: var(--primary-color); border-radius: 50%; cursor: grab; border: 3px solid white; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2); transition: all 0.2s ease; }
    .button-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        justify-content: flex-start;

        /* Posicionamiento absoluto para no mover otros elementos */
        position: absolute;
        top: -80px; /* Subido 30px (de -50px a -80px) */
        left: 50%;
        transform: translateX(-50%);
        z-index: 100;

        /* Ancho y altura controlados - NO CRECE BRUSCAMENTE */
        width: 300px;
        min-height: 350px; /* Altura m√≠nima para acomodar bot√≥n + texto + QR */
        max-height: 600px; /* Altura m√°xima para evitar desbordamiento */
        height: auto; /* Se ajusta autom√°ticamente pero respetando min/max */

        /* Scroll si hay muchos elementos */
        overflow-y: auto;
        overflow-x: hidden;

        /* Fondo semi-transparente para ver mejor */
        background: rgba(249, 250, 251, 0.95);
        padding: 1rem;
        border-radius: var(--radius-lg);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);

        /* Transici√≥n suave si cambia de tama√±o */
        transition: height 0.3s ease;
    }

    /* Scrollbar personalizado para button-group */
    .button-group::-webkit-scrollbar {
        width: 6px;
    }

    .button-group::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 3px;
    }

    .button-group::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 3px;
    }

    .button-group::-webkit-scrollbar-thumb:hover {
        background: var(--primary-hover);
    }
    .btn-primary, .btn-secondary { background: var(--primary-color); color: white; border: none; padding: 0.75rem 2rem; font-size: 1rem; font-weight: 600; border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-normal); }
    .btn-secondary { background: var(--muted-foreground); }
    .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(8, 145, 178, 0.2); }
    .btn-secondary:hover { background: #4b5563; transform: translateY(-2px); }
    #placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white; background: rgba(0,0,0,0.3); padding: 1rem; border-radius: var(--radius-md); }
    #placeholder p { margin: 0.5rem 0; font-size: 1.1rem; }
    .ml-predictions { display: flex; flex-direction: column; gap: 0.25rem; }
    .loading-ml, .error-ml { text-align: center; padding: 1rem; color: var(--muted-foreground); font-style: italic; }
    .error-ml { color: #dc2626; }
    .ml-ready { text-align: center; margin-bottom: 1rem; }
    .ml-ready p { margin: 0.25rem 0; }
    .ml-classes { color: var(--primary-color); font-weight: 600; font-size: 0.9rem; }
    .prediction-item { background: white; padding: 0.75rem 1rem; border-radius: var(--radius-md); border: 1px solid var(--border); display: grid; grid-template-columns: 100px 1fr 70px; gap: 1rem; align-items: center; transition: all var(--transition-normal); }
    .prediction-item.top-prediction { border-width: 2px; border-color: var(--primary-color); }
    .prediction-label { font-weight: 600; color: var(--foreground); font-size: 0.9rem; }
    .prediction-item.top-prediction .prediction-label { color: var(--primary-color); font-weight: 700; }
    .prediction-bar-container { background: var(--muted); height: 16px; border-radius: var(--radius-sm); overflow: hidden; }
    .prediction-bar { background: var(--primary-color); height: 100%; border-radius: var(--radius-sm); transition: width 0.3s ease; }
    .prediction-value { font-weight: 700; font-size: 1rem; color: var(--primary-color); text-align: right; }
    .prediction-item.top-prediction .prediction-value { font-size: 1.3rem; }

    /* Estilos para visualizaci√≥n de evento (restaurado y simplificado) */
    .event-display {
        background: white;
        border-radius: var(--radius-lg);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        padding: 2rem;
        margin-top: 2rem;
        display: none;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.4s ease;
    }
    .event-display.show {
        opacity: 1;
        transform: translateY(0);
    }
    .event-header {
        padding: 0 0 1.5rem 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--border);
        margin-bottom: 1.5rem;
    }
    .event-header h2 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--foreground);
    }
    .event-content { padding: 0; }
    .event-main { display: flex; gap: 1.5rem; align-items: center; margin-bottom: 1.5rem; }
    .event-emoji {
        width: 64px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--muted);
        border-radius: 50%;
        flex-shrink: 0;
    }
    .event-details h3 { margin: 0 0 0.25rem 0; font-size: 1.5rem; color: var(--foreground); }
    .event-date { color: var(--muted-foreground); margin: 0; font-size: 0.9rem; }
    .event-category {
        display: inline-block;
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: var(--radius-sm);
        font-size: 0.9rem;
        font-weight: 600;
        margin-top: 0.5rem;
    }
    .event-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-box { background: var(--muted); padding: 1rem; border-radius: var(--radius-md); text-align: center; }
    .stat-label { display: block; font-size: 0.8rem; color: var(--muted-foreground); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-number { display: block; font-size: 1.8rem; font-weight: 700; color: var(--primary-color); }
    .event-description p { margin: 0; color: var(--foreground); line-height: 1.6; font-size: 1rem; }

    @media (max-width: 1024px) { .main-content { flex-direction: column; } .left-column { flex: 0 0 auto; } .right-column { flex: 1; } }
</style>
</body>

</html>
