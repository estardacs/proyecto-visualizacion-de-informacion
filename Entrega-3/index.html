<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizza Index</title>
    <link rel="icon" href="assets/icons/pizza.svg" type="image/svg+xml">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Scripts de Protobject Framework -->
    <script src="https://app.protobject.com/framework/p.js"></script>
    <script src="config.js"></script>

    <div class="container">
        <header class="header">
            <h1>
                <img src="assets/icons/pizza.svg" alt="Pizza" class="title-icon">
                Pizza Index
            </h1>
            <p>Detector de pizzas en tiempo real - Vista del Computador</p>
        </header>

        <div class="instructions">
            <h2>üìã Instrucciones:</h2>
            <ol>
                <li>Esta p√°gina se abre en tu <strong>COMPUTADOR</strong></li>
                <li>Haz clic en el bot√≥n <strong>"+ Connect"</strong> en la esquina superior derecha</li>
                <li>Escanea el c√≥digo QR con la c√°mara de tu <strong>CELULAR</strong></li>
                <li>En el celular, acepta los permisos de c√°mara</li>
                <li>La detecci√≥n de pizzas aparecer√° aqu√≠ en el computador</li>
            </ol>
        </div>

        <div id="video-container">
            <canvas id="canvas"></canvas>
            <div id="placeholder">
                <p>üì± Esperando conexi√≥n del celular...</p>
                <p class="small">Haz clic en "+ Connect" arriba para generar el QR</p>
            </div>
        </div>

        <div id="info">
            <div id="status">üîµ Esperando conexi√≥n del celular</div>
            <div id="detection">Ninguna pizza detectada</div>
        </div>

        <div class="stats-container">
            <h3>üìä Estad√≠sticas de Detecci√≥n:</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Frames recibidos:</span>
                    <span class="stat-value" id="frame-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Brillo promedio:</span>
                    <span class="stat-value" id="brightness">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üî¥ Rojo:</span>
                    <span class="stat-value" id="red-percent">0%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üü¢ Verde:</span>
                    <span class="stat-value" id="green-percent">0%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üîµ Azul:</span>
                    <span class="stat-value" id="blue-percent">0%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">üü° Amarillo:</span>
                    <span class="stat-value" id="yellow-percent">0%</span>
                </div>
            </div>
        </div>

        <div class="debug-info">
            <h4>üìä Registro de Conexi√≥n:</h4>
            <div id="debug-log"></div>
        </div>

        <footer class="footer">
            <p>Proyecto IIC2026 - Visualizaci√≥n de Informaci√≥n 2025</p>
            <p>Usando Protobject Framework para comunicaci√≥n entre dispositivos</p>
        </footer>
    </div>

    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('status');
        const detectionEl = document.getElementById('detection');
        const debugLog = document.getElementById('debug-log');
        const placeholder = document.getElementById('placeholder');

        let frameCount = 0;
        let isConnected = false;

        // ==========================================
        // FUNCIONES DE DEBUG
        // ==========================================
        function log(message, type = 'info') {
            console.log(message);
            if (debugLog) {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                if (type === 'error') entry.classList.add('log-error');
                if (type === 'success') entry.classList.add('log-success');

                const timestamp = new Date().toLocaleTimeString();
                entry.textContent = `[${timestamp}] ${message}`;

                debugLog.appendChild(entry);
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        }

        function updateStatus(message, type = 'info') {
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = '';
                if (type === 'success') statusEl.classList.add('connected');
                if (type === 'error') statusEl.classList.add('error');
            }
            log(message, type);
        }

        // ==========================================
        // RECIBIR MENSAJES DEL CELULAR
        // ==========================================
        Protobject.Core.onReceived(function (message) {
            if (!isConnected) {
                isConnected = true;
                placeholder.style.display = 'none';
                updateStatus('üü¢ Celular conectado! Recibiendo video...', 'success');
            }

            if (message && message.type === 'frame') {
                mostrarFrame(message.frame);
            }
        });

        // ==========================================
        // MOSTRAR FRAME DEL CELULAR
        // ==========================================
        function mostrarFrame(frameData) {
            const img = new Image();
            img.onload = () => {
                if (canvas.width !== img.width || canvas.height !== img.height) {
                    canvas.width = img.width;
                    canvas.height = img.height;
                }

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);

                frameCount++;
                detectarPizzas();
            };
            img.onerror = () => {
                log('‚ùå Error cargando frame', 'error');
            };
            img.src = frameData;
        }

        // ==========================================
        // DETECCI√ìN DE PIZZAS
        // ==========================================
        function detectarPizzas() {
            if (!canvas.width || !canvas.height) return;

            try {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                let totalBrightness = 0;
                let redPixels = 0;
                let greenPixels = 0;
                let bluePixels = 0;
                let yellowPixels = 0;

                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];

                    totalBrightness += (r + g + b) / 3;

                    // Detectar colores dominantes
                    if (r > 150 && g < 100 && b < 100) redPixels++;
                    if (g > 150 && r < 100 && b < 100) greenPixels++;
                    if (b > 150 && r < 100 && g < 100) bluePixels++;
                    if (r > 150 && g > 150 && b < 100) yellowPixels++; // Amarillo = rojo + verde
                }

                const avgBrightness = Math.round(totalBrightness / (data.length / 4));
                const totalPixels = data.length / 4;

                const redPercent = Math.round(redPixels / totalPixels * 100);
                const greenPercent = Math.round(greenPixels / totalPixels * 100);
                const bluePercent = Math.round(bluePixels / totalPixels * 100);
                const yellowPercent = Math.round(yellowPixels / totalPixels * 100);

                // Actualizar estad√≠sticas
                document.getElementById('frame-count').textContent = frameCount;
                document.getElementById('brightness').textContent = avgBrightness;
                document.getElementById('red-percent').textContent = redPercent + '%';
                document.getElementById('green-percent').textContent = greenPercent + '%';
                document.getElementById('blue-percent').textContent = bluePercent + '%';
                document.getElementById('yellow-percent').textContent = yellowPercent + '%';

                // Detecci√≥n de pizza (colores t√≠picos: rojo del tomate, amarillo del queso)
                let pizzaDetected = '';
                if (yellowPercent > 15 || redPercent > 10) {
                    pizzaDetected = 'üçï ¬°Posible pizza detectada! ';
                    if (yellowPercent > 15) pizzaDetected += '(Queso detectado) ';
                    if (redPercent > 10) pizzaDetected += '(Salsa de tomate detectada) ';
                } else {
                    pizzaDetected = 'Ninguna pizza detectada';
                }

                detectionEl.textContent = pizzaDetected;

            } catch (error) {
                log('‚ùå Error en detecci√≥n: ' + error, 'error');
            }
        }

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        log('üçï Pizza Index iniciado (Computador)', 'success');
        log('üì± Esperando que el celular se conecte...', 'info');
        updateStatus('üîµ Esperando conexi√≥n del celular', 'info');
    </script>
</body>

<style>
    /* Personalizar bot√≥n de conexi√≥n */
    #ProtobjectPlusButton {
        width: 100px !important;
        background-color: var(--primary-color) !important;
        border-radius: var(--radius-md) !important;
        font-family: 'Montserrat', sans-serif !important;
        font-weight: 600 !important;
    }

    #ProtobjectPlusButton:hover {
        background-color: var(--primary-hover) !important;
    }

    #ProtobjectPlusButton:after {
        content: ' Connect';
    }

    #placeholder {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--muted-foreground);
    }

    #placeholder p {
        margin: 0.5rem 0;
        font-size: 1.1rem;
    }

    #placeholder .small {
        font-size: 0.9rem;
        color: var(--primary-color);
    }

    .stats-container {
        background: var(--muted);
        padding: 1.5rem;
        border-radius: var(--radius-lg);
        margin: 1.5rem 0;
        border: 1px solid var(--border);
    }

    .stats-container h3 {
        margin-bottom: 1rem;
        color: var(--foreground);
        font-size: 1.1rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .stat-item {
        background: white;
        padding: 0.75rem;
        border-radius: var(--radius-sm);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--border);
    }

    .stat-label {
        font-weight: 500;
        color: var(--muted-foreground);
    }

    .stat-value {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--primary-color);
    }
</style>

</html>
